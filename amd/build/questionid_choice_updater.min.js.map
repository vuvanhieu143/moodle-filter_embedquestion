{"version":3,"file":"questionid_choice_updater.min.js","sources":["../src/questionid_choice_updater.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * The module provides autocomplete for the question idnumber form field.\n *\n * @module    filter_embedquestion/questionid_choice_updater\n * @package   filter_embedquestion\n * @copyright 2018 The Open University\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/str', 'core/notification', 'core_user/repository'],\n        function($, Ajax, Str, Notification, UserRepository) {\n    var t = {\n        /**\n         * Initialise the handling.\n         *\n         * @param {string} defaultQbankCmid - The default question bank to select, if any.\n         */\n        init: function(defaultQbankCmid) {\n            $('select#id_qbankcmid').on('change', t.qbankChanged);\n            $('select#id_categoryidnumber').on('change', t.categoryChanged);\n\n            t.lastQbank = $('select#id_qbankcmid').val();\n            t.lastCategory = $('select#id_categoryidnumber').val();\n            var selectedText = $('#id_qbankcmid option:selected').text();\n            Str.get_string('currentbank', 'mod_quiz', selectedText)\n                .then(function(string) {\n                    $('#id_questionheadercontainer h5').text(string);\n                    return;\n                }).catch(Notification.exception);\n            if (defaultQbankCmid) {\n                // If a default question bank is set, we need to trigger the change event to load the categories.\n                $('select#id_qbankcmid').val(defaultQbankCmid).trigger('change');\n            }\n        },\n\n        /**\n         * Used to track when the category really changes.\n         */\n        lastCategory: null,\n        /**\n         * Used to track when the question bank really changes.\n         */\n        lastQbank: null,\n\n        /**\n         * Source of data for Ajax element.\n         */\n        categoryChanged: function() {\n            M.util.js_pending('filter_embedquestion-get_questions');\n            t.lastCategory = $('select#id_categoryidnumber').val();\n            if (t.lastCategory === '') {\n                t.updateChoices([]);\n            } else {\n                Ajax.call([{\n                    methodname: 'filter_embedquestion_get_sharable_question_choices',\n                    args: {cmid: t.lastQbank, categoryidnumber: t.lastCategory},\n                }])[0].then(t.updateChoices).catch(Notification.exception);\n                $('select#id_questionidnumber').attr('disabled', false);\n            }\n        },\n\n        /**\n         * Source of data for Ajax element.\n         */\n        qbankChanged: function() {\n            if ($('select#id_qbankcmid').val() === t.lastQbank) {\n                return;\n            }\n            M.util.js_pending('filter_embedquestion-get_categories');\n            t.lastQbank = $('select#id_qbankcmid').val();\n            // Update the heading immediately when selection changes.\n            var selectedText = $('#id_qbankcmid option:selected').text();\n            Str.get_string('currentbank', 'mod_quiz', selectedText)\n                .then(function(string) {\n                    $('#id_questionheadercontainer h5').text(string);\n                    return;\n                }).catch(Notification.exception);\n            var prefKey = 'filter_embedquestion_userdefaultqbank';\n            var courseId = document.querySelector('input[name=\"courseid\"]').value;\n            var isSameCourse = document.querySelector('input[name=\"issamecourse\"]').value;\n            if (isSameCourse) {\n                UserRepository.getUserPreference(prefKey).then(current => {\n                    let prefs = current ? JSON.parse(current) : {};\n                    prefs[courseId] = t.lastQbank;\n                    return UserRepository.setUserPreference(prefKey, JSON.stringify(prefs));\n                }).catch(Notification.exception);\n            }\n            if ($('select#id_qbankcmid').val() === '') {\n                t.updateCategories([]);\n                M.util.js_pending('filter_embedquestion-get_questions');\n                t.updateChoices([]);\n            } else {\n                Ajax.call([{\n                    methodname: 'filter_embedquestion_get_sharable_category_choices',\n                    args: {cmid: t.lastQbank}\n                }])[0].then(t.updateCategories).catch(Notification.exception);\n                M.util.js_pending('filter_embedquestion-get_questions');\n                t.updateChoices([]);\n            }\n        },\n\n        /**\n         * Update the contents of the Question select with the results of the AJAX call.\n         *\n         * @param {Array} response - array of options, each has fields value and label.\n         */\n        updateCategories: function(response) {\n            var select = $('select#id_categoryidnumber');\n\n            select.empty();\n            $(response).each(function(index, option) {\n                select.append('<option value=\"' + option.value + '\">' + option.label + '</option>');\n            });\n            M.util.js_complete('filter_embedquestion-get_categories');\n        },\n\n        /**\n         * Update the contents of the Question select with the results of the AJAX call.\n         *\n         * @param {Array} response - array of options, each has fields value and label.\n         */\n        updateChoices: function(response) {\n            var select = $('select#id_questionidnumber');\n\n            select.empty();\n            $(response).each(function(index, option) {\n                select.append('<option value=\"' + option.value + '\">' + option.label + '</option>');\n            });\n            M.util.js_complete('filter_embedquestion-get_questions');\n        }\n    };\n    return t;\n});\n"],"names":["define","$","Ajax","Str","Notification","UserRepository","t","init","defaultQbankCmid","on","qbankChanged","categoryChanged","lastQbank","val","lastCategory","selectedText","text","get_string","then","string","catch","exception","trigger","M","util","js_pending","updateChoices","call","methodname","args","cmid","categoryidnumber","attr","prefKey","courseId","document","querySelector","value","getUserPreference","current","prefs","JSON","parse","setUserPreference","stringify","updateCategories","response","select","empty","each","index","option","append","label","js_complete"],"mappings":";;;;;;;;AAwBAA,wDAAO,CAAC,SAAU,YAAa,WAAY,oBAAqB,yBACxD,SAASC,EAAGC,KAAMC,IAAKC,aAAcC,oBACrCC,EAAI,CAMJC,KAAM,SAASC,kBACXP,EAAE,uBAAuBQ,GAAG,SAAUH,EAAEI,cACxCT,EAAE,8BAA8BQ,GAAG,SAAUH,EAAEK,iBAE/CL,EAAEM,UAAYX,EAAE,uBAAuBY,MACvCP,EAAEQ,aAAeb,EAAE,8BAA8BY,UAC7CE,aAAed,EAAE,iCAAiCe,OACtDb,IAAIc,WAAW,cAAe,WAAYF,cACrCG,MAAK,SAASC,QACXlB,EAAE,kCAAkCe,KAAKG,WAE1CC,MAAMhB,aAAaiB,WACtBb,kBAEAP,EAAE,uBAAuBY,IAAIL,kBAAkBc,QAAQ,WAO/DR,aAAc,KAIdF,UAAW,KAKXD,gBAAiB,WACbY,EAAEC,KAAKC,WAAW,sCAClBnB,EAAEQ,aAAeb,EAAE,8BAA8BY,MAC1B,KAAnBP,EAAEQ,aACFR,EAAEoB,cAAc,KAEhBxB,KAAKyB,KAAK,CAAC,CACPC,WAAY,qDACZC,KAAM,CAACC,KAAMxB,EAAEM,UAAWmB,iBAAkBzB,EAAEQ,iBAC9C,GAAGI,KAAKZ,EAAEoB,eAAeN,MAAMhB,aAAaiB,WAChDpB,EAAE,8BAA8B+B,KAAK,YAAY,KAOzDtB,aAAc,cACNT,EAAE,uBAAuBY,QAAUP,EAAEM,WAGzCW,EAAEC,KAAKC,WAAW,uCAClBnB,EAAEM,UAAYX,EAAE,uBAAuBY,UAEnCE,aAAed,EAAE,iCAAiCe,OACtDb,IAAIc,WAAW,cAAe,WAAYF,cACrCG,MAAK,SAASC,QACXlB,EAAE,kCAAkCe,KAAKG,WAE1CC,MAAMhB,aAAaiB,eACtBY,QAAU,wCACVC,SAAWC,SAASC,cAAc,0BAA0BC,MAC7CF,SAASC,cAAc,8BAA8BC,OAEpEhC,eAAeiC,kBAAkBL,SAASf,MAAKqB,cACvCC,MAAQD,QAAUE,KAAKC,MAAMH,SAAW,UAC5CC,MAAMN,UAAY5B,EAAEM,UACbP,eAAesC,kBAAkBV,QAASQ,KAAKG,UAAUJ,WACjEpB,MAAMhB,aAAaiB,WAEa,KAAnCpB,EAAE,uBAAuBY,OACzBP,EAAEuC,iBAAiB,IACnBtB,EAAEC,KAAKC,WAAW,sCAClBnB,EAAEoB,cAAc,MAEhBxB,KAAKyB,KAAK,CAAC,CACPC,WAAY,qDACZC,KAAM,CAACC,KAAMxB,EAAEM,cACf,GAAGM,KAAKZ,EAAEuC,kBAAkBzB,MAAMhB,aAAaiB,WACnDE,EAAEC,KAAKC,WAAW,sCAClBnB,EAAEoB,cAAc,OASxBmB,iBAAkB,SAASC,cACnBC,OAAS9C,EAAE,8BAEf8C,OAAOC,QACP/C,EAAE6C,UAAUG,MAAK,SAASC,MAAOC,QAC7BJ,OAAOK,OAAO,kBAAoBD,OAAOd,MAAQ,KAAOc,OAAOE,MAAQ,gBAE3E9B,EAAEC,KAAK8B,YAAY,wCAQvB5B,cAAe,SAASoB,cAChBC,OAAS9C,EAAE,8BAEf8C,OAAOC,QACP/C,EAAE6C,UAAUG,MAAK,SAASC,MAAOC,QAC7BJ,OAAOK,OAAO,kBAAoBD,OAAOd,MAAQ,KAAOc,OAAOE,MAAQ,gBAE3E9B,EAAEC,KAAK8B,YAAY,+CAGpBhD"}