/*
 * The module provides autocomplete for the question idnumber form field.
 *
 * @module    filter_embedquestion/questionid_choice_updater
 * @package   filter_embedquestion
 * @copyright 2018 The Open University
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("filter_embedquestion/questionid_choice_updater",["jquery","core/ajax","core/str","core/notification","core_user/repository"],(function($,Ajax,Str,Notification,UserRepository){var t={init:function(defaultQbank){$("select#id_qbankcmid").on("change",t.qbankChanged),$("select#id_categoryidnumber").on("change",t.categoryChanged),t.lastQbank=$("select#id_qbankcmid").val(),t.lastCategory=$("select#id_categoryidnumber").val();var selectedText=$("#id_qbankcmid option:selected").text();Str.get_string("currentbank","mod_quiz",selectedText).then((function(string){$("#id_questionheadercontainer h5").text(string)})).catch(Notification.exception),defaultQbank&&$("select#id_qbankcmid").val(defaultQbank).trigger("change")},lastCategory:null,lastQbank:null,categoryChanged:function(){M.util.js_pending("filter_embedquestion-get_questions"),t.lastCategory=$("select#id_categoryidnumber").val(),""===t.lastCategory?t.updateChoices([]):(Ajax.call([{methodname:"filter_embedquestion_get_sharable_question_choices",args:{cmid:t.lastQbank,categoryidnumber:t.lastCategory}}])[0].done(t.updateChoices),$("select#id_questionidnumber").attr("disabled",!1))},qbankChanged:function(){if($("select#id_qbankcmid").val()!==t.lastQbank){M.util.js_pending("filter_embedquestion-get_categories"),t.lastQbank=$("select#id_qbankcmid").val();var selectedText=$("#id_qbankcmid option:selected").text();Str.get_string("currentbank","mod_quiz",selectedText).then((function(string){$("#id_questionheadercontainer h5").text(string)})).catch(Notification.exception);var prefKey="filter_embedquestion_userdefaultqbank",courseId=document.querySelector('input[name="courseid"]').value,courseShortname=document.querySelector('input[name="courseshortname"]').value;""!==courseShortname&&null!==courseShortname||UserRepository.getUserPreference(prefKey).then((current=>{let prefs=current?JSON.parse(current):{};return prefs[courseId]=t.lastQbank,UserRepository.setUserPreference(prefKey,JSON.stringify(prefs))})).catch(Notification.exception),""===$("select#id_qbankcmid").val()?(t.updateCategories([]),M.util.js_pending("filter_embedquestion-get_questions"),t.updateChoices([])):(Ajax.call([{methodname:"filter_embedquestion_get_sharable_categories_choices",args:{cmid:t.lastQbank}}])[0].done(t.updateCategories),M.util.js_pending("filter_embedquestion-get_questions"),t.updateChoices([]))}},updateCategories:function(response){var select=$("select#id_categoryidnumber");select.empty(),$(response).each((function(index,option){select.append('<option value="'+option.value+'">'+option.label+"</option>")})),M.util.js_complete("filter_embedquestion-get_categories")},updateChoices:function(response){var select=$("select#id_questionidnumber");select.empty(),$(response).each((function(index,option){select.append('<option value="'+option.value+'">'+option.label+"</option>")})),M.util.js_complete("filter_embedquestion-get_questions")}};return t}));

//# sourceMappingURL=questionid_choice_updater.min.js.map